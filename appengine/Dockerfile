# Base Dockerfile for an App Engine Ruby runtime.
# Dockerfiles generated by the gcloud tool inherit FROM this image.

FROM gcr.io/google_appengine/base

# Install dependencies for Ruby
# Also installs dependencies for the following common gems:
# nokogiri, sqlite3, mysql2, pg
RUN apt-get update -y && \
    apt-get install -y -q --no-install-recommends \
        autoconf \
        build-essential \
        ca-certificates \
        curl \
        git \
        libffi-dev \
        libgdbm-dev \
        libgmp-dev \
        libncurses5-dev \
        libqdbm-dev \
        libreadline6-dev \
        libssl-dev \
        libyaml-dev \
        libz-dev \
        libxml2-dev \
        libsqlite3-dev \
        libmysqlclient-dev \
        libpq-dev \
        systemtap && \
    apt-get clean && \
    rm /var/lib/apt/lists/*_*

# Install node
RUN mkdir /nodejs && curl https://nodejs.org/dist/v4.0.0/node-v4.0.0-linux-x64.tar.gz | tar xvzf - -C /nodejs --strip-components=1
ENV PATH /nodejs/bin:$PATH

# Install rbenv
ENV RBENV_ROOT /rbenv
RUN git clone https://github.com/sstephenson/rbenv.git /rbenv && \
    git clone https://github.com/sstephenson/ruby-build.git /rbenv/plugins/ruby-build
ENV PATH /rbenv/shims:/rbenv/bin:$PATH

# Preinstalled runtimes
RUN rbenv install 2.0.0-p647
RUN rbenv install 2.1.7
RUN rbenv install 2.2.3
RUN rbenv rehash

# Install bundler
RUN RBENV_VERSION=2.0.0-p647 gem install -q --no-rdoc --no-ri bundler --version 1.10.6
RUN RBENV_VERSION=2.1.7 gem install -q --no-rdoc --no-ri bundler --version 1.10.6
RUN RBENV_VERSION=2.2.3 gem install -q --no-rdoc --no-ri bundler --version 1.10.6
RUN rbenv rehash

# Default ruby runtime
RUN rbenv global 2.2.3

# Common configuration for any ENTRYPOINT
WORKDIR /app
EXPOSE 8080
ENV PORT 8080
CMD []

# Default ENTRYPOINT
ENV RACK_HANDLER webrick
ENV RACK_ENV production
ENTRYPOINT bundle exec rackup -p $PORT /app/config.ru -s $RACK_HANDLER -E $RACK_ENV
