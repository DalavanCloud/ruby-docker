# This Dockerfile for a Ruby application was generated by gcloud.

# The base Dockerfile installs:
# * A number of packages needed by the Ruby runtime and by gems
#   commonly used in Ruby web apps (such as libsqlite3)
# * A recent version of NodeJS
# * A recent version of the standard Ruby interpreter to use by default
# * The bundler gem
FROM <%= @base_image %>

# If your application requires a specific ruby version (compatible with rbenv),
# set it here. Leave blank to use the currently recommended default.
ARG REQUESTED_RUBY_VERSION="<%= @ruby_version %>"

# If your application requires additional Debian packages, include their names
# here, space-delimited.
ARG ADDITIONAL_PACKAGES="<%= @packages %>"

# Set up package installs if it is possible we need it.
RUN if test -n "$REQUESTED_RUBY_VERSION" -o -n "$ADDITIONAL_PACKAGES"; then \
      apt-get update -y; \
    fi

# Installs additional Debian packages requested.
RUN if test -n "$ADDITIONAL_PACKAGES"; then \
      apt-get install -y -q $ADDITIONAL_PACKAGES; \
    fi

# Install any requested ruby if not already preinstalled by the base image.
# Tries installing a prebuilt package first, then falls back to a source build.
RUN if test -n "$REQUESTED_RUBY_VERSION" -a \
        ! -x /rbenv/versions/$REQUESTED_RUBY_VERSION/bin/ruby; then \
      apt-get install -y -q gcp-ruby-$REQUESTED_RUBY_VERSION \
      || (cd /rbenv/plugins/ruby-build \
        && git pull \
        && rbenv install -s $REQUESTED_RUBY_VERSION) \
      && rbenv global $REQUESTED_RUBY_VERSION \
      && gem install -q --no-rdoc --no-ri bundler --version $BUNDLER_VERSION; \
    fi

# Clean up package installs.
RUN if test -n "$REQUESTED_RUBY_VERSION" -o -n "$ADDITIONAL_PACKAGES"; then \
      apt-get clean && rm -f /var/lib/apt/lists/*_*; \
    fi

# Copy the application files.
COPY . /app/

# Install required gems if Gemfile.lock is present.
RUN if test -f Gemfile.lock; then \
      bundle install --deployment --without="development test" \
      && rbenv rehash; \
    fi

# Reset entrypoint to override anything set by base image.
ENTRYPOINT []

# Command to start application.
CMD <%= @entrypoint %>
